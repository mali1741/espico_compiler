#define MAX_MINE 8
//12x12rle
char cell[] = {0x6,0x99,0x82,0x96,0x4,0x66,0x83,0x69,0x96,0x4,0x66,0x83,0x69,0x96,0x4,0x66,0x83,0x69,0x96,0x4,0x66,0x83,0x69,0x96,0x4,0x66,0x83,0x69,0x96,0x4,0x66,0x83,0x69,0x96,0x4,0x66,0x83,0x69,0x96,0x4,0x66,0x83,0x69,0x96,0x4,0x66,0x83,0x69,0x9b,0x4,0xbb,0x82,0xb9,0x6,0x99};
char freecell[] = {0x6,0x99,0x82,0x9f,0x4,0xff,0x83,0xf9,0x9f,0x4,0x33,0x83,0xf9,0x9f,0x4,0x33,0x83,0xf9,0x9f,0x4,0x33,0x83,0xf9,0x9f,0x4,0x33,0x83,0xf9,0x9f,0x4,0x33,0x83,0xf9,0x9f,0x4,0x33,0x83,0xf9,0x9f,0x4,0x33,0x83,0xf9,0x9f,0x4,0x33,0x83,0xf9,0x9f,0x4,0xff,0x82,0xf9,0x6,0x99};
char minecell[] = {0x6,0x99,0x82,0x9f,0x4,0xff,0x83,0xf9,0x9f,0x4,0x33,0x85,0xf9,0x9f,0x3b,0x33,0x2,0xb3,0x84,0xf9,0x9f,0x33,0x2,0xbb,0x8b,0x33,0xf9,0x9f,0x3b,0xbf,0xbb,0x33,0xf9,0x9f,0x33,0x2,0xbb,0x90,0x93,0xf9,0x9f,0x33,0x9b,0x99,0x33,0xf9,0x9f,0x3b,0x39,0x33,0x93,0xf9,0x9f,0x4,0x33,0x83,0xf9,0x9f,0x4,0xff,0x82,0xf9,0x6,0x99};
char flagcell[] = {0x6,0x99,0x82,0x96,0x4,0x66,0x91,0x69,0x96,0x66,0xb2,0x26,0x66,0x69,0x96,0x66,0xb2,0x22,0x26,0x69,0x96,0x66,0xb2,0x2,0x22,0x91,0x69,0x96,0x66,0xb2,0x22,0x26,0x69,0x96,0x66,0xb2,0x26,0x66,0x69,0x96,0x66,0xb6,0x2,0x66,0x85,0x69,0x96,0x66,0xb6,0x2,0x66,0x83,0x69,0x96,0x4,0x66,0x83,0x69,0x9b,0x4,0xbb,0x82,0xb9,0x6,0x99};
//12x12
char select[] = {0xdd,0xdd,0xdd,0xdd,0xdd,0xdd,0xd0,0x0,0x0,0x0,0x0,0xd,0xd0,0x0,0x0,0x0,0x0,0xd,0xd0,0x0,0x0,0x0,0x0,0xd,0xd0,0x0,0x0,0x0,0x0,0xd,0xd0,0x0,0x0,0x0,0x0,0xd,0xd0,0x0,0x0,0x0,0x0,0xd,0xd0,0x0,0x0,0x0,0x0,0xd,0xd0,0x0,0x0,0x0,0x0,0xd,0xd0,0x0,0x0,0x0,0x0,0xd,0xd0,0x0,0x0,0x0,0x0,0xd,0xdd,0xdd,0xdd,0xdd,0xdd,0xdd};
//3x5
char n1[] = {0x22,0x0,0x2,0x0,0x2,0x0,0x2,0x0,0x22,0x20};
char n2[] = {0x22,0x20,0x0,0x20,0x22,0x20,0x20,0x0,0x22,0x20};
char n3[] = {0x22,0x20,0x0,0x20,0x22,0x20,0x0,0x20,0x22,0x20};
char n4[] = {0x20,0x20,0x20,0x20,0x22,0x20,0x0,0x20,0x0,0x20};
char n5[] = {0x22,0x20,0x20,0x0,0x22,0x20,0x0,0x20,0x22,0x20};
char n6[] = {0x22,0x20,0x20,0x0,0x22,0x20,0x20,0x20,0x22,0x20};
int numbers[] = {0, n1, n2, n3, n4, n5, n6, n6, n6};

char field[80];

int i,time,key,lastkey,x,y,game,closedcell,firststep;

void init(){
	game = 1;
	firststep = 1;
	time = 0;
	closedcell = 80;
	char r;
	getsprite(1, select);
	spritesetvalue(1, S_WIDTH, 12);
	spritesetvalue(1, S_HEIGHT, 12);
	putsprite(1, 4, 24);
	for(i = 0; i < 80; i++){
		putimagerle(cell,4 + (i % 10) * 12, 24 + (i / 10) * 12, 12, 12);
		field[i] = 0;
	}
	for(i = 0; i < MAX_MINE; i++){
		r = random(80);
		while(field[r])
			r = random(80);
		field[r] = 1;
	}
}

void end(){
	settimer(0, 1000);
	while(gettimer(0)){}
	while(getkey() == 0){}
	game = 0;
}

void printTime(){
	if(gettimer(0) == 0){
		settimer(0, 1000);
		time++;
		gotoxy(9,1);
		printf("%d:%d ", time / 60, time % 60);
	}
}

char testCell(char x1, char y1){
	int c,pos;
	pos = x1 + y1 * 10;
	c = 0;
	if(y1 > 0){
		if(x1 > 0 && field[pos - 11] == 1)
			c=c+1;
		if(field[pos - 10] == 1)
			c=c+1;
		if(x1 < 9 && field[pos - 9] == 1)
			c=c+1;
	}
	if(x1 > 0 && field[pos - 1] == 1)
		c=c+1;
	if(x1 < 9 && field[pos + 1] == 1)
		c=c+1;
	if(y1 < 7){
		if(x1 > 0 && field[pos + 11] == 1)
			c=c+1;
		if(field[pos + 10] == 1)
			c=c+1;
		if(field[pos + 9] == 1)
			c=c+1;
	}
	if(c > 0)
		putimage(numbers[c],8 + x1 * 12, 28 + y1 * 12, 4, 5);
	return c;
}

void openCell(int x1, int y1){
	int c, pos;
	pos = x1 + y1 * 10;
	c = 0;
	if(field[pos] == 0){
		field[pos] = 3;
		closedcell--;
		putimagerle(freecell,4 + x1 * 12, 24 + y1 * 12, 12, 12);
		c = testCell(x1, y1);
		if(c == 0){
			if(x1 > 0)
				openCell(x1 - 1, y1);
			if(x1 < 9)
				openCell(x1 + 1, y1);
			if(y1 > 0)
				openCell(x1, y1 - 1);
			if(y1 < 7)
				openCell(x1, y1 + 1);
			if(x1 > 0 && y1 > 0)
				openCell(x1 - 1, y1 - 1);
			if(x1 < 9 && y1 < 7)
				openCell(x1 + 1, y1 + 1);
			if(y1 > 0 && x1 < 9)
				openCell(x1 + 1, y1 - 1);
			if(y1 < 7 && x1 > 0)
				openCell(x1 - 1, y1 + 1);
		}
	}
}

void setFlag(){
		if(field[x + y * 10] < 2)
			putimagerle(flagcell,4 + x * 12, 24 + y * 12, 12, 12);
}

void action(){
	key = getkey();
	if(key != lastkey){
		lastkey = key;
		if(key == KEY_UP)
			y--;
		if(key == KEY_DOWN)
			y++;
		if(key == KEY_LEFT)
			x--;
		if(key == KEY_RIGHT)
			x++;
		if(key == KEY_A){
			if(firststep){
				firststep = 0;
				field[x + y * 10] = 0;
			}
			if(field[x + y * 10] == 1){
				putimagerle(minecell,4 + x * 12, 24 + y * 12, 12, 12);
				end();
			} 
			else if(field[x + y * 10] == 0){
				openCell(x, y);
			}
		}
		if(key == KEY_B)
			setFlag();
		if(x >= 10)
			x = 0;
		else if(x < 0)
			x = 9;
		if(y >= 8)
			y = 0;
		else if(y < 0)
			y = 7;
		putsprite(1, 4 + x*12, 24 + y*12);
	}
}

void main(){
	while(1){
		init();
		while(game){
			printTime();
			action();
			if(closedcell <= MAX_MINE){
				gotoxy(7,2)
				printf("you win!");
				end();
			}
		}
	}
}
